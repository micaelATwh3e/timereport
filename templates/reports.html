{% extends "base.html" %}

{% block title %}{{ _('Reports') }}{% endblock %}

{% block content %}
<h2>{{ _('Reports') }} {{ year }}</h2>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
    <div>
        <h3>{{ _('Hours by project') }}</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ _('Project') }}</th>
                    <th>{{ _('Total hours') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for project_name, total_hours in project_summary %}
                <tr>
                    <td><strong>{{ project_name }}</strong></td>
                    <td style="text-align: center;">{{ "%.1f"|format(total_hours) }}h</td>
                </tr>
                {% endfor %}
                {% if not project_summary %}
                <tr>
                    <td colspan="2" style="text-align: center; color: #999;">{{ _('No time registered yet') }}</td>
                </tr>
                {% endif %}
            </tbody>
            <tfoot>
                <tr class="summary-row">
                    <td>{{ _('Total') }}</td>
                    <td style="text-align: center;">
                        {{ "%.1f"|format(project_summary|sum(attribute='1')) }}h
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div>
        <h3>{{ _('Leave') }}</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ _('Type') }}</th>
                    <th>{{ _('Number of periods') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for leave_type, count in leave_summary %}
                <tr>
                    <td>
                        {% if leave_type == 'vacation' %}
                            üèñÔ∏è {{ _('Vacation') }}
                        {% else %}
                            ü§í {{ _('Sick leave') }}
                        {% endif %}
                    </td>
                    <td style="text-align: center;">{{ count }}</td>
                </tr>
                {% endfor %}
                {% if not leave_summary %}
                <tr>
                    <td colspan="2" style="text-align: center; color: #999;">{{ _('No leave registered') }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div style="margin-top: 40px; padding: 25px; background: #fafafa; border: 1px solid #ddd;">
    <h3>{{ _('Summary') }}</h3>
    <ul style="list-style: none; padding-left: 0;">
        <li style="padding: 10px; border-bottom: 1px solid #ddd;">
            <strong>{{ _('Total working hours') }}:</strong> 
            {{ "%.1f"|format(project_summary|sum(attribute='1')) }}h
        </li>
        <li style="padding: 10px; border-bottom: 1px solid #ddd;">
            <strong>{{ _('Vacation periods') }}:</strong> 
            {{ leave_summary|selectattr('0', 'equalto', 'vacation')|map(attribute='1')|sum or 0 }}
        </li>
        <li style="padding: 10px; border-bottom: 1px solid #ddd;">
            <strong>{{ _('Sick periods') }}:</strong> 
            {{ leave_summary|selectattr('0', 'equalto', 'sickness')|map(attribute='1')|sum or 0 }}
        </li>
        <li style="padding: 10px; border-bottom: 1px solid #ddd;">
            <strong>{{ _('Travel allowance days') }}:</strong> 
            {{ tracktamente_count }}
        </li>
        <li style="padding: 10px;">
            <strong>{{ _('Comp time earned') }}:</strong> 
            {{ "%.1f"|format(travel_time) }}h
        </li>
    </ul>
</div>

<div style="margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
    <div>
        <h3>{{ _('Monthly summary') }} ({{ _('last 12 months') }})</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ _('Month') }}</th>
                    <th>{{ _('Working days') }}</th>
                    <th>{{ _('Vacation days') }}</th>
                    <th>{{ _('Target') }} ({{ _('hours') }})</th>
                    <th>{{ _('Actual') }} ({{ _('hours') }})</th>
                    <th>{{ _('Fulfillment') }} %</th>
                </tr>
            </thead>
            <tbody>
                {% for month, total in monthly_totals.items()|sort(reverse=True) %}
                <tr>
                    <td>{{ month }}</td>
                    <td style="text-align: center;">{{ monthly_working_days.get(month, 0) }}</td>
                    <td style="text-align: center;">{{ monthly_vacation_days.get(month, 0) }}</td>
                    <td style="text-align: center;">{{ monthly_target_hours.get(month, 0)|int }}</td>
                    <td style="text-align: center;">{{ "%.1f"|format(total) }}h</td>
                    <td style="text-align: center;">{{ monthly_percentages[month] }}%</td>
                </tr>
                {% endfor %}
                {% if not monthly_totals %}
                <tr>
                    <td colspan="6" style="text-align: center; color: #999;">{{ _('No data yet') }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div>
        <h3>{{ _('Yearly summary') }} ({{ _('last 5 years') }})</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ _('Year') }}</th>
                    <th>{{ _('Total hours') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for year_label, total in yearly_totals.items() %}
                <tr>
                    <td>{{ year_label }}</td>
                    <td style="text-align: center;">{{ "%.1f"|format(total) }}h</td>
                </tr>
                {% endfor %}
                {% if not yearly_totals %}
                <tr>
                    <td colspan="2" style="text-align: center; color: #999;">{{ _('No data yet') }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div style="margin-top: 40px; display: grid; grid-template-columns: 1fr; gap: 30px;">
    <div>
        <h3>{{ _('Monthly project fulfillment') }}</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ _('Month') }}</th>
                    <th>{{ _('Project') }}</th>
                    <th>{{ _('Hours') }}</th>
                    <th>{{ _('Target %') }}</th>
                    <th>{{ _('Required hours') }}</th>
                    <th>{{ _('Actual %') }}</th>
                    <th>{{ _('Status') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for month in monthly_totals.keys()|sort|reverse %}
                    {% set month_projects = monthly_project_map.get(month, {}) %}
                    {% set month_total = monthly_totals[month] %}
                    {% set month_targets = monthly_targets.get(month, {}) %}
                    {% set month_target_hours_val = monthly_target_hours.get(month, 0) %}
                    
                    {% if month_projects %}
                        {% for project in projects %}
                            {% set hours = month_projects.get(project.name, 0) %}
                            {% set target = month_targets.get(project.id) %}
                            {% set actual_percent = (hours / month_target_hours_val * 100)|round(1) if month_target_hours_val > 0 else 0 %}
                            {% set needed_hours = (month_target_hours_val * target / 100)|round(1) if target else 0 %}
                            
                            {% if hours > 0 or target %}
                            <tr>
                                <td>{{ month }}</td>
                                <td>{{ project.name }}</td>
                                <td style="text-align: center;">{{ "%.1f"|format(hours) }}h</td>
                                <td style="text-align: center;">{% if target %}{{ target }}%{% else %}-{% endif %}</td>
                                <td style="text-align: center;">{% if target %}{{ needed_hours }}h{% else %}-{% endif %}</td>
                                <td style="text-align: center;">{{ actual_percent }}%</td>
                                <td style="text-align: center;">
                                    {% if target %}
                                        {% if actual_percent >= target %}
                                            <span style="color: #28a745;">‚úì {{ _('OK') }}</span>
                                        {% elif actual_percent >= target - 2 %}
                                            <span style="color: #ffc107;">~ {{ _('Almost') }}</span>
                                        {% else %}
                                            <span style="color: #dc3545;">‚úó {{ _('Below') }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                {% if not monthly_totals %}
                <tr>
                    <td colspan="7" style="text-align: center; color: #999;">{{ _('No data yet') }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div style="margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
    <div>
        <h3>{{ _('Project shares') }} ({{ year }})</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ _('Project') }}</th>
                    <th>{{ _('Hours') }}</th>
                    <th>{{ _('Share') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for row in project_percentages %}
                <tr>
                    <td><strong>{{ row.project }}</strong></td>
                    <td style="text-align: center;">{{ "%.1f"|format(row.hours) }}h</td>
                    <td style="text-align: center;">{{ row.percent }}%</td>
                </tr>
                {% endfor %}
                {% if not project_percentages %}
                <tr>
                    <td colspan="3" style="text-align: center; color: #999;">{{ _('No data yet') }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div>
        <h3>{{ _('Graphs') }}</h3>
        <div style="background: #fafafa; border: 1px solid #ddd; padding: 20px;">
            <canvas id="monthlyChart" height="140"></canvas>
        </div>
        <div style="background: #fafafa; border: 1px solid #ddd; padding: 20px; margin-top: 20px;">
            <canvas id="projectShareChart" height="140"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const monthlyLabels = {{ monthly_totals.keys()|list|tojson }};
const monthlyValues = {{ monthly_totals.values()|list|tojson }};

const projectLabels = {{ project_percentages|map(attribute='project')|list|tojson }};
const projectValues = {{ project_percentages|map(attribute='hours')|list|tojson }};

if (monthlyLabels.length) {
    new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: '{{ _('Hours per month') }}',
                data: monthlyValues,
                backgroundColor: '#2c3e50'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

if (projectLabels.length) {
    new Chart(document.getElementById('projectShareChart'), {
        type: 'doughnut',
        data: {
            labels: projectLabels,
            datasets: [{
                data: projectValues,
                backgroundColor: ['#2c3e50', '#7f8c8d', '#95a5a6', '#bdc3c7', '#34495e']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}
</script>
{% endblock %}
