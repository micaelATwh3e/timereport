{% extends "base.html" %}

{% block title %}{{ month_name }} {{ year }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>{{ month_name }} {{ year }}</h2>
    <div>
        {% if month > 1 %}
            <a href="{{ url_for('month_view', year=year, month=month-1) }}" class="btn btn-secondary">‚Üê {{ _('Previous month') }}</a>
        {% else %}
            <a href="{{ url_for('month_view', year=year-1, month=12) }}" class="btn btn-secondary">‚Üê {{ _('Previous month') }}</a>
        {% endif %}
        
        {% if month < 12 %}
            <a href="{{ url_for('month_view', year=year, month=month+1) }}" class="btn btn-secondary">{{ _('Next month') }} ‚Üí</a>
        {% else %}
            <a href="{{ url_for('month_view', year=year+1, month=1) }}" class="btn btn-secondary">{{ _('Next month') }} ‚Üí</a>
        {% endif %}

        <a href="{{ url_for('month_print', year=year, month=month) }}" class="btn btn-secondary" target="_blank">{{ _('Print') }}</a>
    </div>
</div>

<div style="overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>{{ _('Date') }}</th>
                <th>{{ _('Day') }}</th>
                {% for project in projects %}
                <th>{{ project.name }}</th>
                {% endfor %}
                <th>{{ _('Comp time') }}</th>
                <th>{{ _('Travel allowance') }}</th>
                <th>{{ _('Total hours') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for day in month_data %}
            <tr class="{% if day.is_holiday %}holiday{% elif day.is_weekend %}weekend{% elif day.leave and day.leave.leave_type == 'vacation' %}leave-vacation{% elif day.leave and day.leave.leave_type == 'sickness' %}leave-sickness{% endif %}">
                <td>{{ day.date.strftime('%Y-%m-%d') }}</td>
                <td>
                    {{ day.weekday }}
                    {% if day.leave %}
                        <br><small style="color: #666;">
                            {% if day.leave.leave_type == 'vacation' %}üèñÔ∏è {{ _('Vacation') }}{% else %}ü§í {{ _('Sick leave') }}{% endif %}
                        </small>
                    {% endif %}
                </td>
                {% for project in projects %}
                <td>
                    <input type="number" 
                           class="time-input" 
                           data-date="{{ day.date.strftime('%Y-%m-%d') }}"
                           data-project="{{ project.id }}"
                           value="{% if day.project_hours[project.id] %}{{ day.project_hours[project.id] }}{% endif %}"
                           min="0"
                           max="24"
                           step="0.5"
                           onchange="updateTimeEntry(this)">
                </td>
                {% endfor %}
                <td>
                    <input type="number" 
                           class="time-input" 
                           data-date="{{ day.date.strftime('%Y-%m-%d') }}"
                           data-restid="true"
                           value="{% if day.restid_hours %}{{ day.restid_hours }}{% endif %}"
                           min="0"
                           max="24"
                           step="0.5"
                           onchange="updateTimeEntry(this)">
                </td>
                <td style="text-align: center;">
                    <input type="checkbox" 
                           class="tracktamente-check"
                           data-date="{{ day.date.strftime('%Y-%m-%d') }}"
                           title="{{ _('Travel allowance') }}"
                           style="width: auto; cursor: pointer;"
                           onchange="updateTracktamente(this)"
                           {% if day.restid_tracktamente %}checked{% endif %}>
                </td>
                <td style="text-align: center; font-weight: bold;">{{ day.total }}</td>
            </tr>
            {% endfor %}
            
            <tr class="summary-row">
                <td colspan="2">{{ _('Total') }} ({{ working_days }} {{ _('working days') }})</td>
                {% for project in projects %}
                <td style="text-align: center;">{{ project_totals[project.id] }}</td>
                {% endfor %}
                <td style="text-align: center;">-</td>
                <td style="text-align: center;">-</td>
                <td style="text-align: center;">{{ total_hours }}</td>
            </tr>
            
            <tr style="font-style: italic;">
                <td colspan="2">{{ _('Required working hours') }} ({{ working_days }} √ó 8h)</td>
                <td colspan="{{ projects|length + 3 }}" style="text-align: center;">{{ required_hours }}h</td>
            </tr>
            
            <tr style="font-weight: bold; background: {% if difference >= 0 %}#d4edda{% else %}#f8d7da{% endif %};">
                <td colspan="2">{{ _('Difference') }}</td>
                <td colspan="{{ projects|length + 3 }}" style="text-align: center;">
                    {{ "%.1f"|format(difference) }}h
                    {% if difference >= 0 %}‚úì{% else %}‚ö†Ô∏è{% endif %}
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div style="margin-top: 30px; padding: 20px; background: #fafafa; border: 1px solid #ddd;">
    <h3>{{ _('Legend') }}:</h3>
    <ul style="list-style: none; padding-left: 0;">
        <li style="padding: 5px;"><span style="background: #ffe5e5; padding: 3px 12px; border: 1px solid #ddd;">‚ñ†</span> {{ _('Public holiday') }}</li>
        <li style="padding: 5px;"><span style="background: #fffacd; padding: 3px 12px; border: 1px solid #ddd;">‚ñ†</span> {{ _('Weekend') }}</li>
        <li style="padding: 5px;"><span style="background: #e3f2fd; padding: 3px 12px; border: 1px solid #ddd;">‚ñ†</span> {{ _('Vacation') }}</li>
        <li style="padding: 5px;"><span style="background: #fff3e0; padding: 3px 12px; border: 1px solid #ddd;">‚ñ†</span> {{ _('Sick leave') }}</li>
    </ul>
</div>

{% endblock %}

{% block scripts %}
<script>
function updateTimeEntry(input) {
    const date = input.dataset.date;
    const isRestid = input.dataset.restid === 'true';
    const projectId = input.dataset.project;
    const hours = parseFloat(input.value) || 0;
    
    const payload = {
        date: date,
        hours: hours,
        is_restid: isRestid
    };
    
    if (!isRestid) {
        payload.project_id = projectId;
    }
    
    fetch('/add_time_entry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function updateTracktamente(input) {
    const date = input.dataset.date;
    const isChecked = input.checked;
    
    // Get the restid hours input for the same date (if any)
    const restidInput = document.querySelector(`input[type="number"][data-restid="true"][data-date="${date}"]`);
    const hours = restidInput ? (parseFloat(restidInput.value) || 0) : 0;
    
    fetch('/add_time_entry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            date: date,
            hours: hours,
            is_restid: true,
            tracktamente: isChecked
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - don't reload, just show feedback
            console.log('Tracktamente updated');
        }
    });
}
</script>
{% endblock %}
